@model BTLWebVanChuyen.Models.ViewModels.OrderViewModel
@using BTLWebVanChuyen.Models
@using BTLWebVanChuyen.Utility

@{
    ViewData["Title"] = "Tạo đơn hàng mới";
}

<div class="row justify-content-center mt-4">
    <div class="col-md-9 col-lg-8">
        <div class="card shadow-lg border-0 rounded-4">
            <div class="card-header bg-primary text-white p-4 rounded-top-4 text-center">
                <h3 class="mb-0 fw-bold"><i class="fa-solid fa-cart-plus me-2"></i> @ViewData["Title"]</h3>
                <p class="mb-0 opacity-75">Điền thông tin chi tiết để tạo vận đơn</p>
            </div>

            <div class="card-body p-4">
                <form asp-action="Create" method="post">
                    <div asp-validation-summary="All" class="alert alert-danger border-0 rounded-3 shadow-sm mb-4" style="display:none"></div>

                    <h5 class="text-primary fw-bold mb-3 border-bottom pb-2">1. Thông tin Vận chuyển</h5>
                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold text-secondary small text-uppercase">Khu vực lấy</label>
                            <select asp-for="Order.PickupAreaId" class="form-select bg-light border-0" id="PickupAreaId" style="height: 50px;"
                                    asp-items="@(new SelectList(Model.pickupAreas, "AreaId", "AreaName"))"></select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold text-secondary small text-uppercase">Khu vực giao</label>
                            <select asp-for="Order.DeliveryAreaId" class="form-select bg-light border-0" id="DeliveryAreaId" style="height: 50px;"
                                    asp-items="@(new SelectList(Model.deliveryAreas, "AreaId", "AreaName"))"></select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold text-secondary small text-uppercase">Địa chỉ lấy chi tiết</label>
                        <div class="position-relative">
                            <input asp-for="Order.PickupAddress" id="txtOrigin" class="form-control bg-light border-0"
                                   placeholder="Gõ địa chỉ (VD: Đại học Giao Thông Vận Tải...)" style="height: 50px;"
                                   list="suggestOrigin"
                                   oninput="handleInput(this, 'suggestOrigin')"
                                   onchange="autoCalculate()"
                                   autocomplete="off" />

                            <datalist id="suggestOrigin"></datalist>

                            <span id="loadingOrigin" class="position-absolute top-50 end-0 translate-middle-y me-3 text-primary" style="display:none">
                                <i class="fa-solid fa-circle-notch fa-spin"></i>
                            </span>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label fw-bold text-secondary small text-uppercase">Địa chỉ giao chi tiết</label>
                        <div class="position-relative">
                            <input asp-for="Order.DeliveryAddress" id="txtDestination" class="form-control bg-light border-0"
                                   placeholder="Gõ địa chỉ (VD: Hồ Gươm...)" style="height: 50px;"
                                   list="suggestDest"
                                   oninput="handleInput(this, 'suggestDest')"
                                   onchange="autoCalculate()"
                                   autocomplete="off" />

                            <datalist id="suggestDest"></datalist>

                            <span id="loadingDest" class="position-absolute top-50 end-0 translate-middle-y me-3 text-primary" style="display:none">
                                <i class="fa-solid fa-circle-notch fa-spin"></i>
                            </span>
                        </div>
                    </div>

                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold text-secondary small text-uppercase">Khoảng cách (km)</label>
                            <div class="input-group">
                                <input asp-for="Order.DistanceKm" class="form-control bg-light border-0" id="DistanceKm" type="number" step="0.1" style="height: 50px;" placeholder="0" readonly />
                                <span class="input-group-text bg-light border-0" id="statusIcon">
                                    <i class="fa-solid fa-route text-secondary"></i>
                                </span>
                            </div>
                            <small id="mapStatus" class="text-muted fst-italic" style="font-size: 12px;">Nhập đủ 2 địa chỉ để tự tính km</small>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-bold text-secondary small text-uppercase">Trọng lượng (kg)</label>
                            <input asp-for="Order.WeightKg" class="form-control bg-light border-0" id="WeightKg" type="number" step="0.1" min="0" style="height: 50px;" />
                        </div>
                    </div>

                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label class="form-label fw-bold text-secondary small text-uppercase">Tên người nhận</label>
                            <input asp-for="Order.ReceiverName" class="form-control bg-light border-0" style="height: 50px;" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold text-secondary small text-uppercase">SĐT người nhận</label>
                            <input asp-for="Order.ReceiverPhone" class="form-control bg-light border-0" style="height: 50px;" />
                        </div>
                    </div>

                    <h5 class="text-primary fw-bold mb-3 border-bottom pb-2">3. Thanh toán</h5>
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label class="form-label fw-bold text-secondary small text-uppercase">Người trả cước</label>
                            <select asp-for="Payer" class="form-select bg-light border-0" id="PayerSelect" style="height: 50px;"
                                    asp-items="Html.GetEnumSelectList<PayerType>()"></select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold text-secondary small text-uppercase">Hình thức thanh toán</label>
                            <select asp-for="PaymentMethod" class="form-select bg-light border-0" id="PaymentMethod" style="height: 50px;">
                                <option value="COD">Thanh toán khi nhận hàng (COD)</option>
                                <option value="Online">Thanh toán Online (VNPay)</option>
                            </select>
                        </div>
                    </div>

                    <div class="bg-primary bg-opacity-10 p-4 rounded-4 mb-4 text-center border border-primary border-opacity-25">
                        <h6 class="text-uppercase text-primary fw-bold mb-2">Tổng chi phí dự kiến</h6>
                        <input id="TotalPrice" class="form-control-plaintext text-center fw-bold display-6 text-dark" readonly value="0 VNĐ" />
                    </div>

                    <div class="d-flex gap-3">
                        <button type="submit" class="btn btn-primary w-100 py-3 fw-bold rounded-pill shadow-sm hover-top">Tạo đơn hàng</button>
                        <a asp-controller="Home" asp-action="Index" class="btn btn-light w-100 py-3 fw-bold rounded-pill text-secondary hover-top">Hủy bỏ</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
@section Scripts {
    @await Html.PartialAsync("_ValidationScriptsPartial")

    <script>
        // --- 1. CẤU HÌNH ---
        const priceTables = JSON.parse('@Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.PriceTables))');
        let timeoutSuggest;

        const elOrigin = document.getElementById('txtOrigin');
        const elDest = document.getElementById('txtDestination');
        const elDist = document.getElementById('DistanceKm');
        const elWeight = document.getElementById('WeightKg');
        const elPrice = document.getElementById("TotalPrice");
        const elStatus = document.getElementById('mapStatus');

        const elPickupArea = document.getElementById("PickupAreaId");
        const elDeliveryArea = document.getElementById("DeliveryAreaId");

        // --- 2. SỰ KIỆN ---
        // Khi đổi khu vực -> Check lại ngay lập tức
        elPickupArea.addEventListener("change", () => { validateAndCalculate(); });
        elDeliveryArea.addEventListener("change", () => { validateAndCalculate(); });

        // Khi nhập cân nặng -> Tính tiền
        elWeight.addEventListener("input", () => {
            if(elWeight.value < 0) elWeight.value = 0;
            calculateTotal();
        });

        // Khi nhập địa chỉ (Gõ phím) -> Gợi ý
        elOrigin.addEventListener("input", () => handleInput(elOrigin, 'suggestOrigin'));
        elDest.addEventListener("input", () => handleInput(elDest, 'suggestDest'));

        // Khi rời ô nhập -> Đảm bảo có tọa độ & Check lại khu vực
        elOrigin.addEventListener("change", () => ensureCoordinates(elOrigin));
        elDest.addEventListener("change", () => ensureCoordinates(elDest));

        // --- 3. LOGIC XỬ LÝ NHẬP LIỆU ---
        function handleInput(inputElement, listId) {
            const keyword = inputElement.value;
            if (!keyword) {
                resetState(inputElement);
                return;
            }

            // 1. Check chọn từ list
            const listOptions = document.getElementById(listId).options;
            let found = false;
            for (let i = 0; i < listOptions.length; i++) {
                if (keyword === listOptions[i].value) {
                    inputElement.dataset.lat = listOptions[i].getAttribute('data-lat');
                    inputElement.dataset.lon = listOptions[i].getAttribute('data-lon');
                    validateAndCalculate(); // Chọn xong -> Tính luôn
                    found = true;
                    break;
                }
            }

            if(found) return;

            // 2. Đang gõ -> Xóa tọa độ cũ
            inputElement.removeAttribute('data-lat');
            inputElement.removeAttribute('data-lon');

            // Loading
            inputElement.style.backgroundImage = "url('https://i.gifer.com/ZZ5H.gif')";
            inputElement.style.backgroundRepeat = "no-repeat";
            inputElement.style.backgroundPosition = "right 10px center";
            inputElement.style.backgroundSize = "20px";

            clearTimeout(timeoutSuggest);
            timeoutSuggest = setTimeout(() => {
                fetchSuggestions(keyword, listId, inputElement);
            }, 300);
        }

        async function ensureCoordinates(inputElement) {
            if (inputElement.dataset.lat) return; // Đã có thì thôi

            const keyword = inputElement.value;
            if (!keyword) return;

            // Tìm tọa độ lần cuối nếu user gõ tay
            const coords = await getCoordsNominatim(keyword);
            if (coords) {
                inputElement.dataset.lat = coords.lat;
                inputElement.dataset.lon = coords.lon;
                validateAndCalculate();
            }
        }

        // --- 4. HÀM TÍNH TOÁN & CHECK NGHIÊM NGẶT ---
        async function validateAndCalculate() {
            const originVal = elOrigin.value;
            const destVal = elDest.value;

            // Chưa nhập đủ -> Reset & Thoát
            if (!originVal || !destVal) {
                elDist.value = "";
                calculateTotal();
                return;
            }

            // --- BƯỚC 1: CHECK KHU VỰC (STRICT MODE) ---
            const pickupAreaName = getAreaNameById(elPickupArea.value);
            const deliveryAreaName = getAreaNameById(elDeliveryArea.value);

            // Check Địa chỉ Lấy
            if (!checkAreaMatch(originVal, pickupAreaName)) {
                alert(`❌ SAI KHU VỰC!\nĐịa chỉ lấy: "${originVal}"\nKhông thuộc khu vực: "${pickupAreaName}"\n\nVui lòng nhập lại đúng địa chỉ trong khu vực này.`);

                elOrigin.value = ""; // Xóa trắng ô sai
                elOrigin.removeAttribute('data-lat'); // Xóa tọa độ
                elOrigin.focus(); // Focus lại cho nhập

                resetUIError("Địa chỉ Lấy sai khu vực. Đã xóa.");
                return; // Dừng ngay lập tức
            }

            // Check Địa chỉ Giao
            if (!checkAreaMatch(destVal, deliveryAreaName)) {
                alert(`❌ SAI KHU VỰC!\nĐịa chỉ giao: "${destVal}"\nKhông thuộc khu vực: "${deliveryAreaName}"\n\nVui lòng nhập lại đúng địa chỉ trong khu vực này.`);

                elDest.value = ""; // Xóa trắng ô sai
                elDest.removeAttribute('data-lat');
                elDest.focus();

                resetUIError("Địa chỉ Giao sai khu vực. Đã xóa.");
                return; // Dừng ngay lập tức
            }

            // --- BƯỚC 2: NẾU ĐÚNG KHU VỰC -> MỚI ĐI TÍNH TOÁN ---

            // Đảm bảo có tọa độ (gọi lại ensure nếu cần)
            if (!elOrigin.dataset.lat) await ensureCoordinates(elOrigin);
            if (!elDest.dataset.lat) await ensureCoordinates(elDest);

            const lat1 = elOrigin.dataset.lat;
            const lon1 = elOrigin.dataset.lon;
            const lat2 = elDest.dataset.lat;
            const lon2 = elDest.dataset.lon;

            if (!lat1 || !lat2) return;

            elStatus.innerText = "Đang đo đường...";
            elStatus.className = "text-primary fw-bold blink-animation";

            try {
                // Gọi OSRM tính đường
                let urlRoute = `https://router.project-osrm.org/route/v1/driving/${lon1},${lat1};${lon2},${lat2}?overview=false`;
                let resRoute = await fetch(urlRoute);
                let dataRoute = await resRoute.json();

                if (dataRoute.code === "Ok") {
                    let km = (dataRoute.routes[0].distance / 1000).toFixed(1);
                    elDist.value = km;
                    elStatus.innerText = `✅ Hợp lệ: ${km} km`;
                    elStatus.className = "text-success fw-bold";
                    calculateTotal();
                }
            } catch (err) {
                // Fallback Haversine
                let km = getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2).toFixed(1);
                elDist.value = km;
                elStatus.innerText = `⚠️ Ước tính: ${km} km`;
                elStatus.className = "text-warning fw-bold";
                calculateTotal();
            }
        }

        // --- HELPER FUNCTIONS ---
        function calculateTotal() {
            const pickupId = parseInt(elPickupArea.value);
            const deliveryId = parseInt(elDeliveryArea.value);
            const distance = parseFloat(elDist.value) || 0;
            const weight = parseFloat(elWeight.value) || 0;
            const pickup = priceTables.find(p => p.AreaId === pickupId);
            const delivery = priceTables.find(p => p.AreaId === deliveryId);

            let total = 0;
            if (pickup && delivery && distance > 0 && weight > 0) {
                total = pickup.BasePrice + delivery.BasePrice;
                total += distance * (pickup.PricePerKm + delivery.PricePerKm);
                total += weight * (pickup.WeightPrice + delivery.WeightPrice);
            }
            elPrice.value = total.toLocaleString() + " VNĐ";
        }

        function checkAreaMatch(fullAddress, areaName) {
            if(!fullAddress) return false;
            const cleanFull = removeVietnameseTones(fullAddress).toLowerCase();
            const cleanArea = removeVietnameseTones(areaName).toLowerCase();
            return cleanFull.includes(cleanArea);
        }

        function removeVietnameseTones(str) {
            str = str.replace(/à|á|ạ|ả|ã|â|ầ|ấ|ậ|ẩ|ẫ|ă|ằ|ắ|ặ|ẳ|ẵ/g,"a");
            str = str.replace(/è|é|ẹ|ẻ|ẽ|ê|ề|ế|ệ|ể|ễ/g,"e");
            str = str.replace(/ì|í|ị|ỉ|ĩ/g,"i");
            str = str.replace(/ò|ó|ọ|ỏ|õ|ô|ồ|ố|ộ|ổ|ỗ|ơ|ờ|ớ|ợ|ở|ỡ/g,"o");
            str = str.replace(/ù|ú|ụ|ủ|ũ|ư|ừ|ứ|ự|ử|ữ/g,"u");
            str = str.replace(/ỳ|ý|ỵ|ỷ|ỹ/g,"y");
            str = str.replace(/đ/g,"d");
            str = str.replace(/À|Á|Ạ|Ả|Ã|Â|Ầ|Ấ|Ậ|Ẩ|Ẫ|Ă|Ằ|Ắ|Ặ|Ẳ|Ẵ/g, "A");
            str = str.replace(/È|É|Ẹ|Ẻ|Ẽ|Ê|Ề|Ế|Ệ|Ể|Ễ/g, "E");
            str = str.replace(/Ì|Í|Ị|Ỉ|Ĩ/g, "I");
            str = str.replace(/Ò|Ó|Ọ|Ỏ|Õ|Ô|Ồ|Ố|Ộ|Ổ|Ỗ|Ơ|Ờ|Ớ|Ợ|Ở|Ỡ/g, "O");
            str = str.replace(/Ù|Ú|Ụ|Ủ|Ũ|Ư|Ừ|Ứ|Ự|Ử|Ữ/g, "U");
            str = str.replace(/Ỳ|Ý|Ỵ|Ỷ|Ỹ/g, "Y");
            str = str.replace(/Đ/g, "D");
            return str;
        }

        function getAreaNameById(id) {
            const select = (id == elPickupArea.value) ? elPickupArea : elDeliveryArea;
            return select.options[select.selectedIndex].text;
        }

        function resetUIError(msg) {
            elDist.value = "";
            elStatus.innerText = "❌ " + msg;
            elStatus.className = "text-danger fw-bold";
            document.getElementById("TotalPrice").value = "0 VNĐ";
        }

        function resetState(inputElement) {
            if(inputElement) { inputElement.removeAttribute('data-lat'); inputElement.removeAttribute('data-lon'); }
            elDist.value = "";
            elStatus.innerText = "Đang chờ nhập liệu...";
            elStatus.className = "text-muted fst-italic";
            calculateTotal();
        }

        async function fetchSuggestions(keyword, listId, inputElement) {
            try {
                let url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(keyword)}&countrycodes=vn&accept-language=vi&addressdetails=1&limit=5`;
                let res = await fetch(url);
                let data = await res.json();
                const dataList = document.getElementById(listId);
                dataList.innerHTML = "";
                data.forEach(item => {
                    let option = document.createElement('option');
                    option.value = item.display_name;
                    option.setAttribute('data-lat', item.lat);
                    option.setAttribute('data-lon', item.lon);
                    dataList.appendChild(option);
                });
            } catch (e) { } finally { inputElement.style.backgroundImage = "none"; }
        }

        async function getCoordsNominatim(address) {
            try {
                const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&countrycodes=vn&limit=1`;
                const res = await fetch(url);
                const data = await res.json();
                if (data && data.length > 0) return { lat: data[0].lat, lon: data[0].lon };
            } catch (e) {}
            return null;
        }

        function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
            var R = 6371;
            var dLat = deg2rad(lat2 - lat1);
            var dLon = deg2rad(lon2 - lon1);
            var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }
        function deg2rad(deg) { return deg * (Math.PI / 180); }
    </script>

    <style>
        .blink-animation {
            animation: blinker 0.8s linear infinite;
        }

        @@keyframes blinker {
            50% {
                opacity: 0.5;
            }
        }
    </style>
}