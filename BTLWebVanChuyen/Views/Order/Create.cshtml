@model BTLWebVanChuyen.Models.ViewModels.OrderViewModel
@using BTLWebVanChuyen.Models
@using BTLWebVanChuyen.Utility

@{
    ViewData["Title"] = "Tạo đơn hàng mới";
}

<div class="row justify-content-center mt-4">
    <div class="col-md-9 col-lg-8">
        <div class="card shadow-lg border-0 rounded-4">
            <div class="card-header bg-primary text-white p-4 rounded-top-4 text-center">
                <h3 class="mb-0 fw-bold"><i class="fa-solid fa-cart-plus me-2"></i> @ViewData["Title"]</h3>
                <p class="mb-0 opacity-75">Điền thông tin chi tiết để tạo vận đơn</p>
            </div>

            <div class="card-body p-4">
                <form asp-action="Create" method="post">
                    <div asp-validation-summary="All" class="alert alert-danger border-0 rounded-3 shadow-sm mb-4" style="display:none"></div>

                    <h5 class="text-primary fw-bold mb-3 border-bottom pb-2">1. Thông tin Vận chuyển</h5>
                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold text-secondary small text-uppercase">Khu vực lấy</label>
                            <select asp-for="Order.PickupAreaId" class="form-select bg-light border-0" id="PickupAreaId" style="height: 50px;"
                                    asp-items="@(new SelectList(Model.pickupAreas, "AreaId", "AreaName"))"></select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold text-secondary small text-uppercase">Khu vực giao</label>
                            <select asp-for="Order.DeliveryAreaId" class="form-select bg-light border-0" id="DeliveryAreaId" style="height: 50px;"
                                    asp-items="@(new SelectList(Model.deliveryAreas, "AreaId", "AreaName"))"></select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold text-secondary small text-uppercase">Địa chỉ lấy chi tiết</label>
                        <div class="position-relative">
                            <input asp-for="Order.PickupAddress" id="txtOrigin" class="form-control bg-light border-0"
                                   placeholder="Gõ địa chỉ (VD: Đại học Công nghiệp...)" style="height: 50px;"
                                   list="suggestOrigin"
                                   oninput="handleInput(this, 'suggestOrigin')"
                                   onchange="autoCalculate()"
                                   autocomplete="off" />

                            <datalist id="suggestOrigin"></datalist>

                            <span id="loadingOrigin" class="position-absolute top-50 end-0 translate-middle-y me-3 text-primary" style="display:none">
                                <i class="fa-solid fa-circle-notch fa-spin"></i>
                            </span>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label fw-bold text-secondary small text-uppercase">Địa chỉ giao chi tiết</label>
                        <div class="position-relative">
                            <input asp-for="Order.DeliveryAddress" id="txtDestination" class="form-control bg-light border-0"
                                   placeholder="Gõ địa chỉ (VD: Hồ Gươm...)" style="height: 50px;"
                                   list="suggestDest"
                                   oninput="handleInput(this, 'suggestDest')"
                                   onchange="autoCalculate()"
                                   autocomplete="off" />

                            <datalist id="suggestDest"></datalist>

                            <span id="loadingDest" class="position-absolute top-50 end-0 translate-middle-y me-3 text-primary" style="display:none">
                                <i class="fa-solid fa-circle-notch fa-spin"></i>
                            </span>
                        </div>
                    </div>

                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold text-secondary small text-uppercase">Khoảng cách (km)</label>
                            <div class="input-group">
                                <input asp-for="Order.DistanceKm" class="form-control bg-light border-0" id="DistanceKm" type="number" step="0.1" style="height: 50px;" placeholder="0" readonly />
                                <span class="input-group-text bg-light border-0" id="statusIcon">
                                    <i class="fa-solid fa-route text-secondary"></i>
                                </span>
                            </div>
                            <small id="mapStatus" class="text-muted fst-italic" style="font-size: 12px;">Nhập đủ 2 địa chỉ để tự tính km</small>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-bold text-secondary small text-uppercase">Trọng lượng (kg)</label>
                            <input asp-for="Order.WeightKg" class="form-control bg-light border-0" id="WeightKg" type="number" step="0.1" min="0" style="height: 50px;" />
                        </div>
                    </div>

                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label class="form-label fw-bold text-secondary small text-uppercase">Tên người nhận</label>
                            <input asp-for="Order.ReceiverName" class="form-control bg-light border-0" style="height: 50px;" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold text-secondary small text-uppercase">SĐT người nhận</label>
                            <input asp-for="Order.ReceiverPhone" class="form-control bg-light border-0" style="height: 50px;" />
                        </div>
                    </div>

                    <h5 class="text-primary fw-bold mb-3 border-bottom pb-2">3. Thanh toán</h5>
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label class="form-label fw-bold text-secondary small text-uppercase">Người trả cước</label>
                            <select asp-for="Payer" class="form-select bg-light border-0" id="PayerSelect" style="height: 50px;"
                                    asp-items="Html.GetEnumSelectList<PayerType>()"></select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold text-secondary small text-uppercase">Hình thức thanh toán</label>
                            <select asp-for="PaymentMethod" class="form-select bg-light border-0" id="PaymentMethod" style="height: 50px;">
                                <option value="COD">Thanh toán khi nhận hàng (COD)</option>
                                <option value="Online">Thanh toán Online (VNPay)</option>
                            </select>
                        </div>
                    </div>

                    <div class="bg-primary bg-opacity-10 p-4 rounded-4 mb-4 text-center border border-primary border-opacity-25">
                        <h6 class="text-uppercase text-primary fw-bold mb-2">Tổng chi phí dự kiến</h6>
                        <input id="TotalPrice" class="form-control-plaintext text-center fw-bold display-6 text-dark" readonly value="0 VNĐ" />
                    </div>

                    <div class="d-flex gap-3">
                        <button type="submit" class="btn btn-primary w-100 py-3 fw-bold rounded-pill shadow-sm hover-top">Tạo đơn hàng</button>
                        <a asp-controller="Home" asp-action="Index" class="btn btn-light w-100 py-3 fw-bold rounded-pill text-secondary hover-top">Hủy bỏ</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@* @section Scripts {
    @await Html.PartialAsync("_ValidationScriptsPartial")
    <script>
        const priceTables = JSON.parse('@Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.PriceTables))');

        function calculateTotal() {
            const pickupId = parseInt(document.getElementById("PickupAreaId").value);
            const deliveryId = parseInt(document.getElementById("DeliveryAreaId").value);
            const distance = parseFloat(document.getElementById("DistanceKm").value) || 0;
            const weight = parseFloat(document.getElementById("WeightKg").value) || 0;

            const pickup = priceTables.find(p => p.AreaId === pickupId);
            const delivery = priceTables.find(p => p.AreaId === deliveryId);

            let total = 0;
            if (pickup && delivery) {
                total = pickup.BasePrice + delivery.BasePrice;
                total += distance * (pickup.PricePerKm + delivery.PricePerKm);
                total += weight * (pickup.WeightPrice + delivery.WeightPrice);
            }
            document.getElementById("TotalPrice").value = total.toLocaleString() + " VNĐ";
        }

        document.getElementById("PickupAreaId").addEventListener("change", calculateTotal);
        document.getElementById("DeliveryAreaId").addEventListener("change", calculateTotal);
        document.getElementById("DistanceKm").addEventListener("input", calculateTotal);
        document.getElementById("WeightKg").addEventListener("input", calculateTotal);

        const payerSelect = document.getElementById('PayerSelect');
        const paymentMethodSelect = document.getElementById("PaymentMethod");

        function updatePaymentOptions() {
            if (payerSelect.value === '2') { // Receiver pays
                paymentMethodSelect.value = 'COD';
                paymentMethodSelect.setAttribute('disabled', 'disabled');
            } else {
                paymentMethodSelect.removeAttribute('disabled');
            }
        }
        payerSelect.addEventListener('change', updatePaymentOptions);
        updatePaymentOptions();
    </script>
} *@

@section Scripts {
    @await Html.PartialAsync("_ValidationScriptsPartial")

    <script>
        // --- 1. CẤU HÌNH & BIẾN TOÀN CỤC ---
        const priceTables = JSON.parse('@Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.PriceTables))');
        let timeoutSuggest;

        // Cache các element để đỡ phải tìm lại nhiều lần (Tối ưu hiệu năng)
        const elOrigin = document.getElementById('txtOrigin');
        const elDest = document.getElementById('txtDestination');
        const elDist = document.getElementById('DistanceKm');
        const elWeight = document.getElementById('WeightKg');
        const elPrice = document.getElementById("TotalPrice");
        const elStatus = document.getElementById('mapStatus');
        const elIcon = document.getElementById('statusIcon');

        // Prevent negative weight (extra safety) and keep UI consistent
        function clampWeight(el) {
            if (el == null) return;
            if (el.value === "") return;
            const v = parseFloat(el.value);
            if (isNaN(v)) return;
            if (v < 0) {
                el.value = "0";
            }
        }

        // --- 2. LOGIC TÍNH TIỀN (CORE) ---
        function calculateTotal() {
            const pickupId = parseInt(document.getElementById("PickupAreaId").value);
            const deliveryId = parseInt(document.getElementById("DeliveryAreaId").value);
            const distance = parseFloat(elDist.value) || 0;
            const weight = parseFloat(elWeight.value) || 0;

            const pickup = priceTables.find(p => p.AreaId === pickupId);
            const delivery = priceTables.find(p => p.AreaId === deliveryId);

            let total = 0;

            // Requirement: if either distance OR weight is 0 => total must be 0
            if (pickup && delivery && distance > 0 && weight > 0) {
                total = pickup.BasePrice + delivery.BasePrice;
                total += distance * (pickup.PricePerKm + delivery.PricePerKm);
                total += weight * (pickup.WeightPrice + delivery.WeightPrice);
            } else {
                total = 0;
            }

            elPrice.value = total.toLocaleString() + " VNĐ";
        }

        // Gán sự kiện cơ bản
        document.getElementById("PickupAreaId").addEventListener("change", calculateTotal);
        document.getElementById("DeliveryAreaId").addEventListener("change", calculateTotal);
        elWeight.addEventListener("input", () => { clampWeight(elWeight); calculateTotal(); });


        // --- 3. LOGIC XỬ LÝ ĐỊA CHỈ "THÔNG MINH" ---

        // Hàm này chạy ngay khi người dùng nhấn phím
        function handleInput(inputElement, listId) {
            const keyword = inputElement.value;

            // >>> TÍNH NĂNG MỚI: RESET NGAY LẬP TỨC <<<
            // Bất kể đang gõ hay xóa, cứ đụng vào ô địa chỉ là coi như quãng đường cũ không còn đúng nữa.
            // Reset về 0 ngay để tránh sai sót.
            resetState();

            // Nếu ô nhập trống trơn -> Dừng lại, không gợi ý gì cả
            if (!keyword || keyword.trim() === "") {
                return;
            }

            // Kiểm tra xem người dùng có chọn từ Gợi ý hay không?
            const listOptions = document.getElementById(listId).options;
            let isSelected = false;
            for (let i = 0; i < listOptions.length; i++) {
                if (keyword === listOptions[i].value) {
                    isSelected = true;
                    break;
                }
            }

            // Nếu đã chọn đúng gợi ý -> Tính toán lại từ đầu
            if (isSelected) {
                autoCalculate();
                return;
            }

            // Nếu đang gõ dở -> Tìm gợi ý (Sau 300ms)
            // Hiện icon loading trong ô input
            inputElement.style.backgroundImage = "url('https://i.gifer.com/ZZ5H.gif')";
            inputElement.style.backgroundRepeat = "no-repeat";
            inputElement.style.backgroundPosition = "right 10px center";
            inputElement.style.backgroundSize = "20px";

            clearTimeout(timeoutSuggest);
            timeoutSuggest = setTimeout(() => {
                fetchSuggestions(keyword, listId, inputElement);
            }, 300);
        }

        // Hàm Reset trạng thái về "Con số 0"
        function resetState() {
            elDist.value = ""; // Xóa khoảng cách
            elStatus.innerText = "Đang nhập địa chỉ...";
            elStatus.className = "text-muted fst-italic";
            elIcon.innerHTML = '<i class="fa-solid fa-route text-secondary"></i>';

            calculateTotal(); // Tính lại tiền (về giá gốc) ngay lập tức
        }

        // API Lấy gợi ý (Nominatim)
        async function fetchSuggestions(keyword, listId, inputElement) {
            try {
                let url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(keyword)}&countrycodes=vn&accept-language=vi&limit=5`;
                let res = await fetch(url);
                let data = await res.json();

                const dataList = document.getElementById(listId);
                dataList.innerHTML = "";

                data.forEach(item => {
                    let option = document.createElement('option');
                    option.value = item.display_name;
                    dataList.appendChild(option);
                });
            } catch (e) {
                console.error(e);
            } finally {
                inputElement.style.backgroundImage = "none"; // Tắt loading
            }
        }

        // --- 4. TỰ ĐỘNG TÍNH TOÁN (KHI ĐÃ CHỌN XONG 2 ĐỊA CHỈ) ---
        async function autoCalculate() {
            const originText = elOrigin.value;
            const destText = elDest.value;

            // Chỉ tính khi cả 2 ô đã có dữ liệu
            if (!originText || !destText) return;

            // UI: Báo hiệu đang tính
            elStatus.innerText = "Đang đo khoảng cách...";
            elStatus.className = "text-primary fw-bold blink-animation";
            elIcon.innerHTML = '<i class="fa-solid fa-spinner fa-spin text-primary"></i>';

            try {
                const headers = { "User-Agent": "StudentBTL/1.0" };

                // Gọi song song 2 API tìm tọa độ
                const [res1, res2] = await Promise.all([
                    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(originText)}&countrycodes=vn&limit=1`, {headers}),
                    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(destText)}&countrycodes=vn&limit=1`, {headers})
                ]);

                const data1 = await res1.json();
                const data2 = await res2.json();

                if (data1.length === 0 || data2.length === 0) {
                    // Không tìm thấy thì thôi, vẫn để người dùng nhập tay nếu muốn
                    return;
                }

                // Gọi API OSRM tính đường đi
                let urlRoute = `https://router.project-osrm.org/route/v1/driving/${data1[0].lon},${data1[0].lat};${data2[0].lon},${data2[0].lat}?overview=false`;
                let resRoute = await fetch(urlRoute);
                let dataRoute = await resRoute.json();

                if (dataRoute.code === "Ok") {
                    let km = (dataRoute.routes[0].distance / 1000).toFixed(1);

                    // Gán kết quả
                    elDist.value = km;

                    // UI: Thành công
                    elStatus.innerText = `✅ Quãng đường: ${km} km`;
                    elStatus.className = "text-success fw-bold";
                    elIcon.innerHTML = '<i class="fa-solid fa-check text-success"></i>';

                    // Tính tiền lần cuối
                    calculateTotal();
                }
            } catch (err) {
                console.warn("Lỗi tính toán tự động", err);
                // Nếu lỗi thì reset nhẹ để người dùng biết
                elStatus.innerText = "Không tự tính được. Hãy kiểm tra lại địa chỉ.";
                elStatus.className = "text-warning";
                elIcon.innerHTML = '<i class="fa-solid fa-exclamation text-warning"></i>';
            }
        }
    </script>

    <style>
        .blink-animation {
            animation: blinker 0.8s linear infinite;
        }

        @@keyframes blinker {
            50% {
                opacity: 0.5;
            }
        }
    </style>
}