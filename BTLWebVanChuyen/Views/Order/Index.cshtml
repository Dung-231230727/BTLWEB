@using Microsoft.AspNetCore.Identity
@using BTLWebVanChuyen.Models
@using BTLWebVanChuyen.Utility
@inject UserManager<ApplicationUser> UserManager
@model IEnumerable<Order>

@{
    ViewData["Title"] = "Danh sách đơn hàng";
    var shippers = ViewBag.Shippers as List<Employee> ?? new List<Employee>();
}

<div class="d-flex justify-content-between align-items-center mb-4 mt-3">
    <div>
        <h6 class="text-primary text-uppercase mb-1" style="letter-spacing: 1px;">Quản lý vận chuyển</h6>
        <h2 class="text-dark fw-bold m-0"><i class="fa-solid fa-boxes-stacked me-2 text-primary"></i> @ViewData["Title"]</h2>
    </div>

    @if (User.IsInRole("Customer"))
    {
        <a class="btn btn-primary rounded-pill px-4 py-2 fw-bold shadow-sm hover-top" asp-action="Create">
            <i class="fa-solid fa-plus me-2"></i>Tạo đơn hàng mới
        </a>
    }
</div>

<div class="card shadow-lg border-0 rounded-4 overflow-hidden">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="bg-light">
                    <tr>
                        <th class="py-4 ps-4 text-secondary text-uppercase font-weight-bold small border-0">Khách hàng</th>
                        <th class="py-4 text-secondary text-uppercase font-weight-bold small border-0">Điều phối viên</th>
                        <th class="py-4 text-secondary text-uppercase font-weight-bold small border-0">Shipper</th>
                        <th class="py-4 text-secondary text-uppercase font-weight-bold small border-0">Điểm lấy</th>
                        <th class="py-4 text-secondary text-uppercase font-weight-bold small border-0">Điểm giao</th>
                        <th class="py-4 text-secondary text-uppercase font-weight-bold small border-0">Trạng thái</th>
                        <th class="py-4 text-secondary text-uppercase font-weight-bold small border-0">Ngày tạo</th>
                        <th class="py-4 pe-4 text-center text-secondary text-uppercase font-weight-bold small border-0" style="width: 180px;">Hành động</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var order in Model)
                    {
                        <tr class="border-bottom">
                            <td class="ps-4 py-3 fw-bold text-dark">@order.Customer?.User?.FullName</td>
                            <td class="dispatcher-name text-muted">@(order.Dispatcher?.User?.FullName ?? "---")</td>
                            <td class="text-muted">@(order.Shipper?.User?.FullName ?? "---")</td>
                            <td class="text-muted">@order.PickupArea.AreaName</td>
                            <td class="text-muted">@order.DeliveryArea.AreaName</td>
                            <td>
                                @* Badge trạng thái *@
                                <span class="badge bg-info bg-opacity-10 text-dark border border-info rounded-pill px-3">
                                    @order.Status.GetDisplayName()
                                </span>
                            </td>
                            <td class="text-muted">@order.CreatedAt.ToString("dd/MM/yyyy")</td>
                            <td class="pe-4 py-3">
                                <div class="d-flex flex-column gap-2">
                                    <div class="btn-group shadow-sm w-100" role="group">
                                        <a class="btn btn-light text-primary btn-sm" asp-action="Details" asp-route-id="@order.Id" title="Xem">
                                            <i class="fa-solid fa-eye"></i>
                                        </a>

                                        @if (User.IsInRole("Admin") || User.IsInRole("Dispatcher"))
                                        {
                                            <a class="btn btn-light text-warning btn-sm" asp-action="Edit" asp-route-id="@order.Id" title="Sửa">
                                                <i class="fa-solid fa-pen-to-square"></i>
                                            </a>
                                        }

                                        @if (User.IsInRole("Admin"))
                                        {
                                            <a class="btn btn-light text-danger btn-sm" asp-action="Delete" asp-route-id="@order.Id" title="Xóa">
                                                <i class="fa-solid fa-trash-can"></i>
                                            </a>
                                        }
                                    </div>

                                    @* Dispatcher Logic *@
                                    @if (User.IsInRole("Dispatcher"))
                                    {
                                        <div class="bg-light p-2 rounded-3 border">
                                            <form asp-action="Assign" method="post" class="d-flex gap-1 assign-form mb-1">
                                                <input type="hidden" name="orderId" value="@order.Id" />
                                                <select name="shipperId" class="form-select form-select-sm border-0">
                                                    <option value="">-- Shipper --</option>
                                                    @foreach (var shipper in shippers)
                                                    {
                                                        var selected = order.ShipperId == shipper.Id ? "selected" : "";
                                                        <option value="@shipper.Id" selected="@(selected)">@shipper.User?.FullName</option>
                                                    }
                                                </select>
                                                <button type="button" class="btn btn-primary btn-sm btn-assign"><i class="fa-solid fa-check"></i></button>
                                            </form>
                                            @if (order.Status == OrderStatus.Failed)
                                            {
                                                <form asp-action="UpdateStatus" method="post" class="d-flex gap-1 cancel-form">
                                                    <input type="hidden" name="orderId" value="@order.Id" />
                                                    <select name="status" class="form-select form-select-sm border-0">
                                                        <option value="@OrderStatus.Cancelled">@OrderStatus.Cancelled.GetDisplayName()</option>
                                                    </select>
                                                    <button type="button" class="btn btn-danger btn-sm btn-cancel"><i class="fa-solid fa-xmark"></i></button>
                                                </form>
                                            }
                                        </div>
                                    }

                                    @* Shipper Logic *@
                                    @if (User.IsInRole("Shipper"))
                                    {
                                        <form asp-action="UpdateStatus" method="post" class="d-flex gap-1 shipper-form mt-1">
                                            <input type="hidden" name="orderId" value="@order.Id" />
                                            <select name="status" class="form-select form-select-sm bg-light border-0">
                                                @foreach (var status in Enum.GetValues(typeof(OrderStatus)).Cast<OrderStatus>())
                                                {
                                                    if (status == OrderStatus.Delivering || status == OrderStatus.Delivered || status == OrderStatus.Failed)
                                                    {
                                                        var selected = order.Status == status ? "selected" : "";
                                                        <option value="@status" selected="@(selected)">@status.GetDisplayName()</option>
                                                    }
                                                }
                                            </select>
                                            <button type="submit" class="btn btn-success btn-sm rounded"><i class="fa-solid fa-floppy-disk"></i></button>
                                        </form>
                                    }
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function updateOrderStatus(orderId, status, callback) {
            var token = document.querySelector('input[name="__RequestVerificationToken"]').value;
            fetch('@Url.Action("UpdateStatus")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'RequestVerificationToken': token
                },
                body: `orderId=${orderId}&status=${status}`
            })
            .then(res => res.json())
            .then(data => callback(data))
            .catch(err => console.error(err));
        }

        document.querySelectorAll('.btn-assign').forEach(btn => {
            btn.type = "button";
            btn.addEventListener('click', function() {
                var form = this.closest('.assign-form');
                var orderId = form.querySelector('input[name="orderId"]').value;
                var shipperId = form.querySelector('select[name="shipperId"]').value;
                var token = document.querySelector('input[name="__RequestVerificationToken"]').value;

                fetch('@Url.Action("Assign")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'RequestVerificationToken': token
                    },
                    body: `orderId=${orderId}&shipperId=${shipperId}`
                })
                .then(res => res.json())
                .then(data => {
                    var row = form.closest('tr');
                    var dispatcherSpan = row.querySelector('.dispatcher-name');
                    if(dispatcherSpan) dispatcherSpan.textContent = data.dispatcherName;
                    row.querySelector('td:nth-child(6) span').textContent = data.statusDisplay; // Updated selector for badge
                    var cancelForm = row.querySelector('.cancel-form');
                    if(cancelForm) cancelForm.style.display = 'none';
                })
                .catch(err => console.error(err));
            });
        });

        document.querySelectorAll('.btn-cancel').forEach(btn => {
            btn.type = "button";
            btn.addEventListener('click', function() {
                var form = this.closest('.cancel-form');
                var orderId = form.querySelector('input[name="orderId"]').value;
                var status = form.querySelector('select[name="status"]').value;

                updateOrderStatus(orderId, status, function(data) {
                    var row = form.closest('tr');
                    row.querySelector('td:nth-child(6) span').textContent = data.statusDisplay; // Updated selector for badge
                    var dispatcherSpan = row.querySelector('.dispatcher-name');
                    if(dispatcherSpan) dispatcherSpan.textContent = data.dispatcherName;
                });
            });
        });

        document.querySelectorAll('.shipper-form').forEach(form => {
            var btn = form.querySelector('button.btn-success');
            if(btn) {
                btn.type = "button";
                btn.addEventListener('click', function() {
                    var orderId = form.querySelector('input[name="orderId"]').value;
                    var status = form.querySelector('select[name="status"]').value;

                    updateOrderStatus(orderId, status, function(data) {
                        var row = form.closest('tr');
                        row.querySelector('td:nth-child(6) span').textContent = data.statusDisplay; // Updated selector for badge
                    });
                });
            }
        });
    </script>
}